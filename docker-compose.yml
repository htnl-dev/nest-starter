services:
  nest-starter-mongodb-dev:
    image: mongo:8
    container_name: nest-starter-mongodb-dev
    hostname: nest-starter-mongodb-dev
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongodb_data_dev:/data/db
      - ./mongodb/mongo-local-dev-keyfile:/etc/mongo-keyfile:ro
    networks:
      - nest-starter-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    command: mongod --wiredTigerCacheSizeGB 1 --auth --replSet rs0 --keyFile /etc/mongo-keyfile --bind_ip 127.0.0.1,nest-starter-mongodb-dev
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    env_file:
      - ./.env.local

  nest-starter-mongodb-init:
    image: mongo:8
    restart: "no"
    depends_on:
      nest-starter-mongodb-dev:
        condition: service_healthy
    env_file:
      - ./.env.local
    networks:
      - nest-starter-network
    entrypoint:
      - bash
      - -c
      - |
        echo "Waiting 25 seconds for everything to settle..."
        sleep 25

        echo "Initializing replica set with authentication..."
        mongosh --host nest-starter-mongodb-dev:27017 \
                -u "${MONGODB_USER}" \
                -p "${MONGODB_PASSWORD}" \
                --authenticationDatabase admin \
                --quiet \
                --eval '
          let needsInit = false;

          try {
            const status = rs.status();
            if (status.ok === 1) {
              print("Replica set already initialized");
              printjson(status);
            } else {
              needsInit = true;
            }
          } catch(e) {
            if (e.message.includes("no replset config")) {
              print("No replica set config found, initializing...");
              needsInit = true;
            } else {
              print("Error checking replica set status: " + e.message);
              throw e;
            }
          }

          if (needsInit) {
            print("Initializing replica set...");
            const result = rs.initiate();
            printjson(result);

            print("Waiting for primary election...");
            sleep(5000);

            print("Final replica set status:");
            printjson(rs.status());
          }
        '

        echo "Replica set initialization complete!"

  nest-starter-redis-dev:
    image: redis:8-alpine
    container_name: nest-starter-redis-dev
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data_dev:/data
      - ./redis.dev.conf:/usr/local/etc/redis/redis.conf
    networks:
      - nest-starter-network
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    command: redis-server /usr/local/etc/redis/redis.conf
    env_file:
      - ./.env.local

  # Tus file upload server
  nest-starter-tus-dev:
    image: tusproject/tusd:latest
    container_name: nest-starter-tus-dev
    ports:
      - "${TUS_PORT:-8080}:8080"
    volumes:
      - tus_data:/srv/tusd/data
    networks:
      - nest-starter-network
    environment:
      - TUSD_BASE_PATH=/uploads
      - TUSD_PATH=/files
      - TUSD_DATA_STORE=/srv/tusd/data
      - TUSD_UPLOAD_SIZE_LIMIT=104857600 # 100MB in bytes
      - TUSD_CORS_ALLOW_ORIGIN=*
      - TUSD_CORS_ALLOW_METHODS=POST,GET,OPTIONS,HEAD,PATCH,DELETE
      - TUSD_CORS_ALLOW_HEADERS=*
      - TUSD_CORS_EXPOSE_HEADERS=*
    restart: unless-stopped

  nest-starter-api-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: nest-starter-api-dev
    ports:
      - "${API_PORT:-5050}:${API_PORT:-5050}"
    volumes:
      - ./:/usr/src/app
      - /usr/src/app/node_modules
      - nest_starter_data_dev:/usr/src/app/data
    env_file:
      - ./.env.local
    depends_on:
      - nest-starter-mongodb-dev
      - nest-starter-redis-dev
      - nest-starter-caddy
      - nest-starter-tus-dev
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    networks:
      - nest-starter-network

  nest-starter-caddy:
    image: caddy:latest
    container_name: nest-starter-caddy
    ports:
      - "4321:4321"
      - "2019:2019"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
      - ./logs/caddy:/var/log/caddy
    networks:
      - nest-starter-network
    restart: unless-stopped

  # PostgreSQL for Logto
  nest-starter-postgres-dev:
    image: postgres:18-alpine
    container_name: nest-starter-postgres-dev
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-logto}
      POSTGRES_USER: ${POSTGRES_USER:-devuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    networks:
      - nest-starter-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-devuser} -d ${POSTGRES_DB:-logto}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Logto authentication service
  nest-starter-logto-dev:
    image: ghcr.io/logto-io/logto:1.34.0
    container_name: nest-starter-logto-dev
    depends_on:
      nest-starter-postgres-dev:
        condition: service_healthy
      nest-starter-redis-dev:
        condition: service_started
    entrypoint: ["sh", "-c", "npm run cli db seed -- --swe && npm run cli db alteration deploy next && npm start"]
    ports:
      - "${LOGTO_PORT:-3001}:3001"
      - "${LOGTO_ADMIN_PORT:-3002}:3002"
    environment:
      DB_URL: postgres://${POSTGRES_USER:-devuser}:${POSTGRES_PASSWORD:-devpassword}@nest-starter-postgres-dev:5432/${POSTGRES_DB:-logto}
      REDIS_URL: redis://:${REDIS_PASSWORD:-devredispass}@nest-starter-redis-dev:6379
      ENDPOINT: ${LOGTO_ENDPOINT:-http://localhost:3001}
      ADMIN_ENDPOINT: ${LOGTO_ADMIN_ENDPOINT:-http://localhost:3002}
      NODE_ENV: development
      TRUST_PROXY_HEADER: 1
    networks:
      - nest-starter-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    restart: unless-stopped

volumes:
  mongodb_data_dev:
  redis_data_dev:
  postgres_data_dev:
  caddy_data:
  caddy_config:
  nest_starter_data_dev:
  tus_data:

networks:
  nest-starter-network:
    driver: bridge